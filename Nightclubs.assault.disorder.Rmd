---
title: "Spatial regression between on-premise liquor licensed locations and crime"
author: "Erica Turner"
date: "4/25/2020"
output: html_document
---

In our final project, we looked at the relationship between certain businesses in Washington DC and certain types of crimes occuring late at night (10pm-4am). More specifically we looked at the relationship between on-premise liquor licensed locations  (e.g. bars, taverns, arenas) and crime incidents falling under the categories of simple assault and disorderly conduct. 

[more on spatial nature of this research question  ]

Our hypothesis going into this research was that crime would be positively associated with the presence of on-premise liquor licensed locations.


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message=FALSE, warning = FALSE)
library(tidyverse)
library(knitr) 
library(tmap)
library(sf)
library(spdep)
library(car)
library(GWmodel)
library(gridExtra)
library(httr)
library(sp)
library(methods)
library(broom)
library(tidycensus)
library(stringr)
```

## Loading data

We first loaded in data sets for arrests and for liquor licensed locations from DC Open Data. 

For the arrests data set, we ignored the location of where the arrest occured and focused instead on the location of the offense itself, since people may have been arrested far from where the incident occured. This data set has drawbacks however, since it only records incidents for which there was an arrest made, which introduces bias. For instance, police may have had more success tracking down black offenders, since majority-black neighborhoods in DC are more heavily policed and more equipped with CCTV cameras. Moreover, black Washingtonians are disproportionately stopped and arrested across DC neighborhoods, especially for minor offenses (which disorderly conduct qualifies as). (1)(2)


Source 

1. https://opendata.dc.gov/datasets/closed-circuit-tv-street-cameras?geometry=-77.375%2C38.787%2C-76.634%2C38.974
2. https://wamu.org/story/19/05/14/aclu-study-finds-d-c-s-black-residents-arrested-at-higher-rate-for-largely-minor-offenses/


```{r load data and subset,  results="hide"}
arrests <-read.csv("./datasets/Adult_Arrests.csv")
liquor <-read.csv("./datasets/Liquor_Licenses.csv")
```

## Subsetting arrests 

Here, we narrowed down arrests to simple assaults and disorderly conduct, occurring in 2017, between the hours of 10am and 4am, and those not missing data for longitude or latitude. 

We also narrowed down the types of disorderly conduct to those likely to happen as a result of intoxication (e.g. we eliminated leash law violations)

[Limitation: liquor licensed locations data set is a living document, so the data are from 2020 whereas arrests data are from 2017]


```{r subsetting arrests,  results="hide"}
unique(arrests$CATEGORY)

arrests2 <- arrests %>%
  subset(YEAR > 2016) %>%
  subset(CATEGORY == "Simple Assault" | CATEGORY == "Disorderly Conduct")
  
arrests2[!is.na(arrests2$OFFENSE_LONGITUDE),]
arrests2[!is.na(arrests2$OFFENSE_LATITUDE),]

#Unique values of Disorderly Conduct to eliminate those not likely related to alcohol  
arrests3 <- subset(arrests2, CATEGORY == "Disorderly Conduct")
unique(arrests3$DESCRIPTION)

arrests4 <- arrests2 %>%
  subset(DESCRIPTION != "Animals - Other Than Dogs At Large "  | 
           DESCRIPTION != "Illegal Dumping" |
           DESCRIPTION != "Dogs - Vacci tion Required " |
           DESCRIPTION != "Dogs - At Large" |
           DESCRIPTION != "Crossing Police Line" |
           DESCRIPTION != "Dogs - Unleashed"   |
           DESCRIPTION != "Wearing Hood Or Mask ---  (a) No Person Or Persons Over 16 Years Of
           Age, While Wearing Any Mask, Hood, Or Device Whereby Any Po" |
           DESCRIPTION != "Crowding, Obstructing, or Incommoding (M)"  |
           DESCRIPTION != "Panhandling"  |
           DESCRIPTION != "Aggressive Panhandling" |
           DESCRIPTION != "Dog Regulations - Unleashed Dog " |
           DESCRIPTION != "Blocking Passage" |
           DESCRIPTION != "Metro - Fail To Pay Fare" |
           DESCRIPTION != "Disorderly Conduct In A Public Building" |
           DESCRIPTION != "Panhandling - Aggressive" |
           DESCRIPTION != "Panhandling - Private Property" |
            DESCRIPTION != "Dogs - Disturbing The Peace" |
            DESCRIPTION != "Dog - Dangerous Dog Attack Or Bite" |
            DESCRIPTION != "Attending Or Kindling Bonfires " )

arrests5 <- arrests4 %>%
  subset(HOUR == 22:23 |
           HOUR == 0:4) 

arrests <- arrests5
rm(arrests2, arrests3, arrests4, arrests5)

assault <- arrests %>%
  subset(CATEGORY == "Simple Assault")

disorder <-  arrests %>%
  subset(CATEGORY == "Disorderly Conduct")

```


## Subsetting liquor licenses

Next, we narrowed down liquor licensed locations to those that are on-premise (bars, taverns, and arenas). This eliminated locations where people are buying alcohol to-go (e.g. grocery stores) 

```{r subsetting liquor to on-premise locations, results="hide" }
unique(liquor$STATUS)
liquor <- subset(liquor, STATUS == "Active" |
                   STATUS == "Issued")

unique(liquor$TYPE)
liquor2<- liquor %>%
  subset(TYPE == "Club"  |
           TYPE == "Nightclub"  |
           TYPE == "Tavern"  |
           TYPE == "Arena")
           
liquor2[!is.na(liquor2$LONGITUDE),]
liquor2[!is.na(liquor2$LATITUDE),]  

liquor <- liquor2

rm(liquor2)

```

## Plotting disorderly conduct, simple assault and bar locations 

Next, we plotted simple choropleths to assess visually if the locations of bars and arrests seemed related

```{r some exploratory data analysis with ggplot}
tracts_shp<-st_read("./datasets/Census_Tracts_in_2010-shp/bafa98d7-cd1a-449a-8ccf-addab06aa319202041-1-js13da.tzjit.shp")
tracts_shp<-subset(tracts_shp, select=c("geometry", "TRACT", "SQ_MILES"))
#tracts_shp<-tracts_shp[-c(12),] #delete tract 2.02, which is missing income data (see below)



plot.both <- ggplot(data=tracts_shp) + geom_sf(aes(fill=NULL)) + labs(title="Arrests for simple assault\nand disorderly conduct\n+ bar locations (2017)") 

plot.both + geom_point(data=assault, aes(x=OFFENSE_LONGITUDE, y=OFFENSE_LATITUDE), size = .2, alpha= .5, color="red") +
  geom_point(data=disorder, aes(x=OFFENSE_LONGITUDE, y=OFFENSE_LATITUDE), size = .2, alpha= .5, color="blue") +
  geom_point(data=liquor, aes(x=LONGITUDE, y=LATITUDE), size = .2, alpha= .5, color="black")

```

## Joining arrests and liquor locations

Next, we joined the data sets for liquor licensed locations with arrests, then converted it to a spatial format

```{r join arrests and bars and convert to sf}
arrests<-arrests[!is.na(arrests$OFFENSE_LONGITUDE),]
arrests<-arrests[!is.na(arrests$OFFENSE_LATITUDE),]

arrests<-subset(arrests, select=c("YEAR", "DATE_", "HOUR", "CATEGORY", "OFFENSE_LATITUDE", "OFFENSE_LONGITUDE"))
liquor<-subset(liquor, select=c("TRADE_NAME", "TYPE", "LATITUDE", "LONGITUDE"))
arrests$LATITUDE<-arrests$OFFENSE_LATITUDE
arrests$LONGITUDE<-arrests$OFFENSE_LONGITUDE
arrests<-subset(arrests, select=c("YEAR", "DATE_", "HOUR", "CATEGORY", "LATITUDE", "LONGITUDE"))

arrests_sf<- st_as_sf(arrests,
                       coords = c("LONGITUDE", "LATITUDE"), crs = 4326)

liquor_sf<- st_as_sf(liquor,
                       coords = c("LONGITUDE", "LATITUDE"), crs = 4326)


#rm(arrests)
#rm(assault)
#rm(disorder)
#rm(liquor)
```

## Adding control variables

Next, we added a variety of control variables by tract including...

```{r add controls}
census_api_key("816f34b70c5f746503c5eb778287ef105fdb3902", install=TRUE, overwrite=TRUE)

acs <-get_acs(geography = "tract", 
          variables= c("B06009_005E", "B07001_017E", "B11015_002E", 
                       "B12001_003E", "B17001_002E", "B25105_001E", 
                       "B19013_001", "B25010_003E", "B23025_007E", 
                       "B23008_012E", "B01002_002E", "B01001_002E", 
                       "B01001H_008E", "B01001H_009E","B02001_002E",
                       "B02001_003", "B03001_001", "B01001_002E", 
                       "B14001_008M", "B01002_001E"),
          year=2018, state="DC") 

acs<-subset(acs, select=c("estimate", "GEOID", "variable"))
acs<-spread(acs, variable, estimate)

acs$bach<-acs$B06009_005
acs$transcience<-acs$B07001_017
acs$non_relatives<-acs$B11015_002
acs$males_never_married<-acs$B12001_003
acs$poverty<-acs$B17001_002
acs$housing_costs<-acs$B25105_001
acs$med_hh_income<-acs$B19013_001
acs$hhsize_rental<-acs$B25010_003
acs$not_labforce<-acs$B23025_007
acs$under6_mom<-acs$B23008_012

acs$med_male_age<-acs$B01002_002
acs$males_20_24<-acs$B01001H_008	
acs$males_25_29<-acs$B01001H_009
acs$white<-acs$B02001_002
acs$black<-acs$B02001_003
acs$hisp<-acs$B03001_001
acs$tot_male<-acs$B01001_002
acs$coll_enroll<-acs$B14001_008
acs$med_age<-acs$B01002_001




pop_shp<-st_read("./datasets/ACS_2018_Population_Variables_Tract-shp/1a06e536-b186-4e78-bab7-63836dce84f82020328-1-r1rbgx.oico.shp")
pop_shp$tot_pop<-pop_shp$B01001_001
pop_shp$area<-pop_shp$Shape__Are
pop_shp<-subset(pop_shp, select=c("geometry", "tot_pop", "NAME", "GEOID", "area"))


#get tract names to match up between population data set and census tract data set 
pop_shp$TRACT<-substring(pop_shp$GEOID, 6)
pop_shp<-subset(pop_shp, select=c("geometry", "tot_pop", "TRACT", "area"))
acs$TRACT<-substring(acs$GEOID, 6)
acs<-subset(acs, select=c("bach", "transcience", 
                          "non_relatives", "males_never_married", 
                          "poverty", "housing_costs", "med_hh_income",
                          "hhsize_rental", "not_labforce", "under6_mom", "TRACT" , 
                          "tot_male" , "med_male_age", "males_20_24", "males_25_29", 
                          "white", "black", "hisp", "coll_enroll", "med_age"))
                          

#population as df to enable join with acs
pop_shp<-as.data.frame(pop_shp)


#create new variables of arrests per tract and liquor stores per tract
arrests_in_tract <- st_join(arrests_sf, tracts_shp, join = st_within)
arrests_count <- count(as_tibble(arrests_in_tract), TRACT) %>%
  print()

liquor_in_tract <- st_join(liquor_sf, tracts_shp, join = st_within)
liquor_count <- count(as_tibble(liquor_in_tract), TRACT) %>%
  print()


main <- left_join(pop_shp, acs, by="TRACT")
main<-left_join(main, arrests_count, by="TRACT", all.x=TRUE)
main$arrests_count <- main$n
main$n <-NULL
main$arrests_count[is.na(main$arrests_count)] <- 0

main<-left_join(main, liquor_count, by="TRACT", all.x=TRUE)
main$liquor_count <- main$n
main$n <-NULL
main$liquor_count[is.na(main$liquor_count)] <- 0

#delete tracts missing data (see if we can fill with data?)
#main<-main[-c(68),]
#main<-main[-c(2),]
#main<-main[-c(75),]
#main<-main[-c(73),]


sq.miles<-subset(tracts_shp, select=c("TRACT", "SQ_MILES"))
sq.miles$geometry <- NULL
main<-left_join(main, sq.miles, by="TRACT")

#generate pop density variable
main<- mutate(main, popdens = tot_pop/SQ_MILES)


#turn totals into percentages
main <- mutate(main, bach = bach/tot_pop)
main <- mutate(main, tot_bach = bach)


main <- mutate(main, transcience = transcience/tot_pop)
main <- mutate(main, non_relatives = non_relatives/tot_pop)
main <- mutate(main, males_never_married = males_never_married/tot_male)

main <- mutate(main, poverty = poverty/tot_pop)
main <- mutate(main, tot_poverty = poverty)

main <- mutate(main, not_labforce = not_labforce/tot_pop)

main <- mutate(main, under6_mom = under6_mom/tot_pop)

main <- mutate(main, males_20_24 = males_20_24/tot_male)
main <- mutate(main, tot_males_20_24 = males_20_24)

main <- mutate(main, males_25_29 = males_25_29/tot_male)
main <- mutate(main, tot_males_25_29 = males_25_29)

main <- mutate(main, white = white/tot_pop)
main <- mutate(main,tot_white = white)

main <- mutate(main, black = black/tot_pop)
main <- mutate(main, tot_black = black)

main <- mutate(main, hisp = hisp/tot_pop)
main <- mutate(main, male_to_total = tot_male/tot_pop)
main <- mutate(main, coll_enroll = coll_enroll/tot_pop)
main <- mutate(main, tot_coll_enroll = coll_enroll)

main<- na.omit(main)

```

## Regression and visual spatial autocorrelation

[add description]

```{r regression}
#OLS regression
main_sf<- st_sf(main,
                sf_column_name = c("geometry"))

fit_1 <- lm(arrests_count ~liquor_count + tot_pop + popdens +
             med_hh_income + males_25_29, data=main_sf)

#r-squared
summary(fit_1)$r.squared

#Alternative way to look at OLS results with broom package
broom_summary<-tidy(fit_1)
broom_summary

```

In this simple OLS specfication, the variables significant at the 10% level are:

  1. Number of on-premise liquor licensed locations
  2. Total population
  3. Median household income
  5. Percentage of total males that are 25-29

[mention how R2 is low, limitations of our specification]


```{r spatial autocorrelation}
#Visual test of spatial autocorrelation, using rersiduals
main_sf$res_fit1 <- residuals(fit_1)
main_sf$fitted_fit1 <- fitted(fit_1)

main_sf$sd_breaks <- scale(main_sf$res_fit1)[,1]
summary(main_sf$sd_breaks)
my_breaks <- c(14,-3,-2,-1,1,2,3,14) #not sure if we need this 

ggplot(data=main_sf) + 
  scale_fill_gradient2(breaks=my_breaks,
                       low = "springgreen4",
                       mid = "white",
                       high = "red",)+
  geom_sf(aes(fill=sd_breaks, geometry=geometry)) + 
  labs(title="residuals") 

```

It is unclear from this plot if there is spatial autocorrelation of either over-prediction (green) or under-prediction (red) going on. A more formal test for spatial autocorrelation is needed.


## Formal test for spatial autocorrelation

```{r spatial autocorrelation cont.}
#Formal test of spatial autocorrelation
main_sp <- as(main_sf, "Spatial")

#Then we create a list of neighbours using the Queen criteria
w <- poly2nb(main_sp, row.names=main_sp$TRACT)
summary(w)
```

The summary of "w" describes the distribution of connectedness across our data. Tracts have an average of almost 6 neighbors.  

Next, we created a row standardize spatial weight matrix and the Moran Scatterplot. [describe what these are]

```{r spatial weight matrix and Moran Scatterplot}

wm <- nb2mat(w, style='B')
rwm <- mat2listw(wm, style='W')

lm.morantest(fit_1, rwm, alternative="two.sided")

```

The p-value of Moran's I is not significant, therefore we cannot reject the null that arrests for assault and disorderly conduct are randomly distributed throughout Census tracts in DC. In other words, this model does not demonstrate spatial autocorrelation. 

However, for the purposes of learning how to use a novel geospatial technique, we will nevertheless proceed with spatial regression model.  

## Sub-regional analysis 

[Describe why some researchers choose to do multiple spatial regressions for different sub-regions. See Chapter 9]
[See also Baller et. al 2001: STRUCTURAL COVARIATES OF U.S. COUNTY HOMICIDE RATES: INCORPORATING SPATIAL EFFECTS]

```{r sub region analysis on quads}

quads<-st_read("./datasets/quadrants.csv")
quads$TRACT<-as.numeric(quads$TRACT)
main_sf$TRACT <-as.numeric(main_sf$TRACT)
main_sf<-left_join(main_sf, quads, by="TRACT")

#verify quadrant coding worked
ggplot(data=main_sf) +
  geom_sf(aes(fill=as.factor(QUAD))) #tiny bit of overlap b/c quads don't line up perfectly with tracts

ggplot(main_sf, aes(x = res_fit1, colour = as.factor(QUAD))) + 
  geom_density() 


```

Some interesting differences among quadrants. 

[more interpreation]


```{r lagrange multipliers}
#subset quads
main_NW_sf <- subset(main_sf, QUAD == "NW")
main_NE_sf <- subset(main_sf, QUAD == "NE")
main_SW_sf <- subset(main_sf, QUAD == "SW")
main_SE_sf <- subset(main_sf, QUAD == "SE")

#Turn sf into sp
main_NW_sp <- as(main_NW_sf , "Spatial")
main_NE_sp <- as(main_NE_sf , "Spatial")
main_SW_sp <- as(main_SW_sf , "Spatial")
main_SE_sp <- as(main_SE_sf , "Spatial")


#Then we create a list of neighbours using the Queen criteria
w_NW <- poly2nb(main_NW_sp, row.names=main_NW_sp$TRACT)

wm_NW <- nb2mat(w_NW, style='B')
rwm_NW <- mat2listw(wm_NW, style='W')

fit_NW<- lm(arrests_count ~liquor_count + tot_pop + popdens +
             med_hh_income + males_25_29, data=main_NW_sf)

#NE neighbors
w_NE <- poly2nb(main_NE_sp, row.names=main_NE_sp$TRACT)

wm_NE <- nb2mat(w_NE, style='B')
rwm_NE <- mat2listw(wm_NE, style='W')

fit_NE<- lm(arrests_count ~liquor_count + tot_pop + popdens +
             med_hh_income + males_25_29, data=main_NE_sf)

#SW neighbors
w_SW <- poly2nb(main_SW_sp, row.names=main_SW_sp$TRACT)

wm_SW <- nb2mat(w_SW, style='B')
rwm_SW <- mat2listw(wm_SW, style='W')

fit_SW<- lm(arrests_count ~liquor_count + tot_pop + popdens +
             med_hh_income + males_25_29, data=main_SW_sf)

#SE neighbors
w_SE <- poly2nb(main_SE_sp, row.names=main_SE_sp$TRACT)

wm_SE <- nb2mat(w_SE, style='B')
rwm_SE <- mat2listw(wm_SE, style='W')

fit_SE<- lm(arrests_count ~liquor_count + tot_pop + popdens +
             med_hh_income + males_25_29, data=main_SE_sf)



```


```{r morans I by quad}

lm.morantest(fit_NW, rwm_NW, alternative="two.sided")

lm.morantest(fit_NE, rwm_NE, alternative="two.sided")

lm.morantest(fit_SW, rwm_SW, alternative="two.sided") 

lm.morantest(fit_SE, rwm_SE, alternative="two.sided") 

```

P-value is not significant for NW, NE, and SE. [For SW, sample size too small?] No need to run multiple spatially lagged models for each quadrant. Can proceed with one spatially lagged model for all of DC. 


```{r spatially lagged model}
#Then we create a list of neighbours using the Queen criteria
fit_lagged <- errorsarlm(arrests_count ~liquor_count + tot_pop + popdens +
             med_hh_income + males_25_29, data=main_sf, rwm)

summary(fit_lagged)

```

In the spatially lagged model, variables significant at the 10% level are the same as in the )LS model: 

  1. Number of on-premise liquor licensed locations
  2. Total population
  3. Median household income
  4. Percentage of total males that are 25-29
  
This was to be expected because we were not able to demonstrate spatial autocorrelation.

[maybe describe slight differences in p-values, and why]

