---
title: "Spatial cross-correlation between bar locations and assault + disorderly conduct"
author: "Erica Turner"
date: "4/25/2020"
output: html_document
---

In our final project, we will be looking at the relationship between different types of infrastructure in DC and different types of crime using geospatial analysis. In this first piece of analysis, we look at the relationship between the locations of 

 1. Bars 
 2. Simple assaults and disorderly conduct occurring late at night (10pm to 4am)


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message=FALSE, warning = FALSE)
library(tidyverse)
library(knitr) 
library(tmap)
library(sf)
library(spdep)
library(car)
library(GWmodel)
library(gridExtra)
library(httr)
library(sp)
library(methods)
library(broom)
library(tidycensus)
library(GISTools)
```

## Loading data

Loading in csv for arrest data and liquor licensed locations from DC Open Data, both of which include longitude and latitude. 

```{r load data and subset,  results="hide"}
arrests <-read.csv("./datasets/Adult_Arrests.csv")
liquor <-read.csv("./datasets/Liquor_Licenses.csv")
```

## Subsetting arrests 

Here, we narrowed down arrests to simple assaults and disorderly conduct, occurring in 2017, between the hours of 10am and 4am, and those not missing data for longitude or latitude. 

We also narrowed down the types of disorderly conduct to those likely to happen as a result of intoxication (e.g. we eliminated leash law violations)


```{r subsetting arrests,  results="hide"}
unique(arrests$CATEGORY)

arrests2 <- arrests %>%
  subset(YEAR > 2016) %>%
  subset(CATEGORY == "Simple Assault" | CATEGORY == "Disorderly Conduct")
  
arrests2[!is.na(arrests2$OFFENSE_LONGITUDE),]
arrests2[!is.na(arrests2$OFFENSE_LATITUDE),]

#Unique values of Disorderly Conduct to eliminate those not likely related to alcohol  
arrests3 <- subset(arrests2, CATEGORY == "Disorderly Conduct")
unique(arrests3$DESCRIPTION)

arrests4 <- arrests2 %>%
  subset(DESCRIPTION != "Animals - Other Than Dogs At Large "  | 
           DESCRIPTION != "Illegal Dumping" |
           DESCRIPTION != "Dogs - Vacci tion Required " |
           DESCRIPTION != "Dogs - At Large" |
           DESCRIPTION != "Crossing Police Line" |
           DESCRIPTION != "Dogs - Unleashed"   |
           DESCRIPTION != "Wearing Hood Or Mask ---  (a) No Person Or Persons Over 16 Years Of
           Age, While Wearing Any Mask, Hood, Or Device Whereby Any Po" |
           DESCRIPTION != "Crowding, Obstructing, or Incommoding (M)"  |
           DESCRIPTION != "Panhandling"  |
           DESCRIPTION != "Aggressive Panhandling" |
           DESCRIPTION != "Dog Regulations - Unleashed Dog " |
           DESCRIPTION != "Blocking Passage" |
           DESCRIPTION != "Metro - Fail To Pay Fare" |
           DESCRIPTION != "Disorderly Conduct In A Public Building" |
           DESCRIPTION != "Panhandling - Aggressive" |
           DESCRIPTION != "Panhandling - Private Property" |
            DESCRIPTION != "Dogs - Disturbing The Peace" |
            DESCRIPTION != "Dog - Dangerous Dog Attack Or Bite" |
            DESCRIPTION != "Attending Or Kindling Bonfires " )

arrests5 <- arrests4 %>%
  subset(HOUR == 22 |
           HOUR == 0:4) 

arrests <- arrests5
rm(arrests2, arrests3, arrests4, arrests5)

assault <- arrests %>%
  subset(CATEGORY == "Simple Assault")

disorder <-  arrests %>%
  subset(CATEGORY == "Disorderly Conduct")

```


## Subsetting liquor licenses

Next, we narrowed down liquor licensed locations to bars, taverns, and arenas. This eliminated locations where people are buying alcohol to-go (e.g. grocery stores) 

```{r subsetting liquor to on-premise locations, results="hide" }
unique(liquor$STATUS)
liquor <- subset(liquor, STATUS == "Active" |
                   STATUS == "Issued")

unique(liquor$TYPE)
liquor2<- liquor %>%
  subset(TYPE == "Club"  |
           TYPE == "Nightclub"  |
           TYPE == "Tavern"  |
           TYPE == "Arena")
           
liquor2[!is.na(liquor2$LONGITUDE),]
liquor2[!is.na(liquor2$LATITUDE),]  

liquor <- liquor2

rm(liquor2)

```

## Plotting disorderly conduct, simple assault and bar locations 

Next, we plotted simple choropleths to assess visually if the locations of bars and arrests seemed related

```{r some exploratory data analysis with ggplot}
tracts_shp<-st_read("./datasets/Census_Tracts_in_2010-shp/bafa98d7-cd1a-449a-8ccf-addab06aa319202041-1-js13da.tzjit.shp")
tracts_shp<-subset(tracts_shp, select=c("geometry", "TRACT", "SQ_MILES"))
#tracts_shp<-tracts_shp[-c(12),] #delete tract 2.02, which is missing income data (see below)


plot.both <- ggplot(data=tracts_shp) + geom_sf(aes(fill=NULL)) + labs(title="Arrests for simple assault\nand disorderly conduct\n+ bar locations (2017)") 

plot.both + geom_point(data=assault, aes(x=OFFENSE_LONGITUDE, y=OFFENSE_LATITUDE), size = .2, alpha= .5, color="red") +
  geom_point(data=disorder, aes(x=OFFENSE_LONGITUDE, y=OFFENSE_LATITUDE), size = .2, alpha= .5, color="blue") +
  geom_point(data=liquor, aes(x=LONGITUDE, y=LATITUDE), size = .2, alpha= .5, color="black")

```

## Joining arrests and liquor locations


Next, we joined the data sets for liquor licensed locations with arrests, then converted it to a spatial format

```{r join arrests and bars and convert to sf}
arrests<-arrests[!is.na(arrests$OFFENSE_LONGITUDE),]
arrests<-arrests[!is.na(arrests$OFFENSE_LATITUDE),]

arrests<-subset(arrests, select=c("YEAR", "DATE_", "HOUR", "CATEGORY", "OFFENSE_LATITUDE", "OFFENSE_LONGITUDE"))
liquor<-subset(liquor, select=c("TRADE_NAME", "TYPE", "LATITUDE", "LONGITUDE"))
arrests$LATITUDE<-arrests$OFFENSE_LATITUDE
arrests$LONGITUDE<-arrests$OFFENSE_LONGITUDE
arrests<-subset(arrests, select=c("YEAR", "DATE_", "HOUR", "CATEGORY", "LATITUDE", "LONGITUDE"))

arrests_sf<- st_as_sf(arrests,
                       coords = c("LONGITUDE", "LATITUDE"), crs = 4326)

liquor_sf<- st_as_sf(liquor,
                       coords = c("LONGITUDE", "LATITUDE"), crs = 4326)


#rm(arrests)
#rm(assault)
#rm(disorder)
#rm(liquor)
```

## Adding control variables

Next, we added a variety of control variables by tract including median male, ... [add]

```{r add controls}
census_api_key("816f34b70c5f746503c5eb778287ef105fdb3902", install=TRUE, overwrite=TRUE)

#Variables: 
#median male age B01002_002E
#total males 20-24 B01001H_008E	
#total males 25-29 B01001H_009E	
#total unmarried males not in labor force B12006_007E
#total white B02001_002E
#total black B02001_003E
#total hispanic B03001_001E

acs <-get_acs(geography = "tract", 
          variables= c("B01002_002E", "B01001H_008E", "B01001H_009E", 
                       "B12006_007E", "B02001_002E", "B02001_003E", "B03001_001E"),
          year=2018, state="DC") 

acs<-subset(acs, select=c("estimate", "GEOID", "variable"))
acs<-spread(acs, variable, estimate)

acs$med_male_age<-acs$B01002_002
acs$tot_males_20_24<-acs$B01001H_008	
acs$tot_males_25_29<-acs$B01001H_009
acs$tot_males_not_labforce<-acs$B12006_007
acs$tot_white<-acs$B02001_002
acs$tot_black<-acs$B02001_003
acs$tot_hisp<-acs$B03001_001

pop_shp<-st_read("./datasets/ACS_2018_Population_Variables_Tract-shp/1a06e536-b186-4e78-bab7-63836dce84f82020328-1-r1rbgx.oico.shp")
pop_shp$tot_pop<-pop_shp$B01001_001
pop_shp$area<-pop_shp$Shape__Are
pop_shp<-subset(pop_shp, select=c("geometry", "tot_pop", "NAME", "GEOID", "area"))


#get tract names to match up between population data set and census tract data set 
pop_shp$TRACT<-substring(pop_shp$GEOID, 6)
pop_shp<-subset(pop_shp, select=c("geometry", "tot_pop", "TRACT", "area"))
acs$TRACT<-substring(acs$GEOID, 6)
acs<-subset(acs, select=c("med_male_age", "tot_males_20_24", 
                          "tot_males_25_29", "tot_males_not_labforce", 
                          "tot_white", "tot_black", "tot_hisp", "TRACT"))

#population as df to enable join with acs
pop_shp<-as.data.frame(pop_shp)


#create new variables of arrests per tract and liquor stores per tract
arrests_in_tract <- st_join(arrests_sf, tracts_shp, join = st_within)
arrests_count <- count(as_tibble(arrests_in_tract), TRACT) %>%
  print()

liquor_in_tract <- st_join(liquor_sf, tracts_shp, join = st_within)
liquor_count <- count(as_tibble(liquor_in_tract), TRACT) %>%
  print()


main <- left_join(pop_shp, acs, by="TRACT")
main<-left_join(main, arrests_count, by="TRACT", all.x=TRUE)
main$arrests_count <- main$n
main$n <-NULL
main$arrests_count[is.na(main$arrests_count)] <- 0

main<-left_join(main, liquor_count, by="TRACT", all.x=TRUE)
main$liquor_count <- main$n
main$n <-NULL
main$liquor_count[is.na(main$liquor_count)] <- 0

#generate pop density variable
main<- mutate(main, popdens = tot_pop/area)

#delete the tract that's missing data
main<-main[-c(68),]
```

## Regression and visual spatial autocorrelation

```{r regression}
#OLS regression
fit_1 <- lm(arrests_count ~ liquor_count + tot_pop + med_male_age +
              tot_males_20_24 + tot_males_25_29 + tot_males_not_labforce +
              tot_white + tot_black + tot_hisp + popdens, data=main)

#r-squared
summary(fit_1)$r.squared

#Alternative way to look at OLS results with broom package
broom_summary<-tidy(fit_1)
broom_summary

```

Only liquor location count is significant


```{r spatial autocorrelation}
#Visual test of spatial autocorrelation, using rersiduals
main$res_fit1 <- residuals(fit_1)
main$fitted_fit1 <- fitted(fit_1)

main$sd_breaks <- scale(main$res_fit1)[,1]
summary(main$sd_breaks)
my_breaks <- c(14,-3,-2,-1,1,2,3,14) #not sure if we need this 

ggplot(data=main) + 
  scale_fill_gradient2(breaks=my_breaks,
                       low = "springgreen4",
                       mid = "white",
                       high = "red",)+
  geom_sf(aes(fill=sd_breaks, geometry=geometry)) + 
  labs(title="residuals") 

```

Not quite sure if there is spatial autocorrelation of either over-prediction (green) or under-prediction (red) going on. 


Sources for regression

1. https://maczokni.github.io/crimemapping_textbook_bookdown/spatial-regression-models.html#introduction-3

## Formal test for spatial autocorrelation

```{r spatial autocorrelation cont.}
#Formal test of spatial autocorrelation
main_sf<- st_sf(main,
                sf_column_name = c("geometry"))

main_sp <- as(main_sf, "Spatial")

#Then we create a list of neighbours using the Queen criteria
w <- poly2nb(main_sp, row.names=main_sp$TRACT)
summary(w)
```

The summary of "w" describes the distribution of connectedness across our data. Tracts have an average of almost 6 neighbors.  

Next, we created a row standardize spatial weight matrix and the Moran Scatterplot. [describe what these are]

```{r spatial weight matrix and Moran Scatterplot}

wm <- nb2mat(w, style='B')
rwm <- mat2listw(wm, style='W')

lm.morantest(fit_1, rwm, alternative="two.sided")

```

p-value of Moran's I is significant, therefore we can reject the null that arrests for assault and disorderly conduct are randomly distributed throughout Census tracts in DC.

This indicates the presence of spatial autocorrelation, so we therefore need to do a spatial regression model.  

```{r better controls}
## Try a new model with better controls


```
